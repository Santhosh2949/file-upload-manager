<script>
  const fileInput = document.getElementById('fileInput');
  const uploadForm = document.getElementById('uploadForm');
  const uploadBtn = uploadForm.querySelector('button[type="submit"]');

  // Show chosen filename (mobile fix)
  fileInput.addEventListener('change', function (e) {
    if (this.files && this.files.length) {
      let name = this.files[0].name;
      let span = document.getElementById('chosen') || document.createElement('span');
      span.id = 'chosen';
      span.textContent = ' ' + name;
      this.parentNode.insertBefore(span, this.nextSibling);
      // enable button if it was disabled for some reason
      uploadBtn.disabled = false;
    }
  });

  // Prevent double submits and handle offline/failed uploads gracefully
  uploadForm.addEventListener('submit', function (e) {
    // if no file chosen, block submit
    if (!fileInput.files || fileInput.files.length === 0) {
      e.preventDefault();
      alert('Please choose a file first.');
      return;
    }

    // If navigator reports offline, warn user immediately and block submit
    if (!navigator.onLine) {
      e.preventDefault();
      alert('Your phone is offline. Connect to the same Wi-Fi as your PC (or turn on hotspot) to upload.');
      return;
    }

    // disable submit to avoid double-clicks while request is in-flight
    uploadBtn.disabled = true;
    uploadBtn.textContent = 'Uploading...';

    // add a timeout fallback: if after 5s no page reload, re-enable so user can try again
    window._uploadTimeout = setTimeout(() => {
      uploadBtn.disabled = false;
      uploadBtn.textContent = 'Upload';
      // keep UX clean: clear file input so mobile can choose same file again
      try { fileInput.value = ''; } catch (err) {}
      const chosen = document.getElementById('chosen');
      if (chosen) chosen.remove();
      alert('Upload seems to be taking too long â€” check your network and try again.');
    }, 5000);
  });

  // When page loads (after a redirect from server), clear any pending timeout and reset form
  window.addEventListener('load', function () {
    if (window._uploadTimeout) {
      clearTimeout(window._uploadTimeout);
      window._uploadTimeout = null;
    }
    // reset form (clears file input so mobile filepicker works again)
    if (uploadForm) uploadForm.reset();
    const chosen = document.getElementById('chosen');
    if (chosen) chosen.remove();
    if (uploadBtn) {
      uploadBtn.disabled = false;
      uploadBtn.textContent = 'Upload';
    }
  });
</script>
